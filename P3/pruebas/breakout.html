<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script type="text/javascript" src="raf.js"></script>
<script type="text/javascript" src="Paddle.js"></script>
<script type="text/javascript" src="BreakoutBall.js"></script>				
<script>
	var paddle; //will store the paddle object
	var ball;
	var ctx;
	var canvas;
	var WIDTH;
	var HEIGHT;
	var rightDown = false, leftDown =  false;
	var lives = 3;
	var score = 0;
	
	// add brick variables
	var bricks;
	var NROWS;
	var NCOLS;
	var BRICKWIDTH;
	var BRICKHEIGHT;
	var PADDING;

	function init() {
		canvas = document.getElementById("canvas");			
		//canvas.bgcolor
		ctx = canvas.getContext("2d");
		
		WIDTH = canvas.width;
		HEIGHT = canvas.height;
		ctx.fillStyle = '#000000';
		ctx.fillRect(0,0,WIDTH, HEIGHT);
		
		console.log("hello");	
		paddle = new Paddle(8,100);
		paddle.x = WIDTH/2 - paddle.width/2;
		paddle.y = HEIGHT - paddle.height;
				
		ball = new BreakoutBall(10, "#ffffff");
		
		startGame();
		paddle.draw(ctx);
		
		loop();
	}
	function initBricks() {
		NROWS = 5;
		NCOLS = 10;
		BRICKWIDTH = (WIDTH/NCOLS) - 1;
		BRICKHEIGHT = 15;
		PADDING = 1;

		//2D array for bricks
		bricks = new Array(NROWS);
		for (i=0; i < NROWS; i++) {
			bricks[i] = new Array(NCOLS);
				for (j=0; j < NCOLS; j++) {
					bricks[i][j] = 1;
				}
		}
		//console.log(bricks);
	}
	function startGame() {
		score = 0;
		//start position of ball
		ball.x = WIDTH/2;
		ball.y = HEIGHT/2;
		
		initBricks();
		//randomising velocity of ball
		
	}
	
	
	function loop() {
		//drawing black square
		ctx.fillStyle = '#000000';
		ctx.fillRect(0,0,WIDTH, HEIGHT);
		
		//draw the Bricks
		ctx.fillStyle='#333333';
		//only bricks with Array Entry bricks [x][x] == 1 will drawn
		for (i=0; i < NROWS; i++) {
			for (j=0; j < NCOLS; j++) {
				if (bricks[i][j] == 1) {
					ctx.fillRect((j * (BRICKWIDTH + PADDING)) + PADDING,
					(i * (BRICKHEIGHT + PADDING) + PADDING),
					BRICKWIDTH, BRICKHEIGHT);
				}
			}
		}
		//hitting a brick?
		//have we hit a brick?
		rowheight = BRICKHEIGHT + PADDING;
		colwidth = BRICKWIDTH + PADDING;
		//what row we are in
		row = Math.floor(ball.y/rowheight);
		col = Math.floor(ball.x/colwidth);


		//if so, reverse the ball and mark the brick as broken

		if (ball.y < NROWS * rowheight && row >= 0 && col >= 0 && bricks[row][col] == 1) {
			ball.dy *= -1;
			bricks[row][col] = 0;
			score += 2;
		}
		
		//setting fonts up
		ctx.fillStyle='#cccccc';
		ctx.font = "30px Arial";
		ctx.fillText("Breakout", 250, 30);
		
		ctx.fillStyle='#cccccc';
		ctx.font = "20px Arial";
		ctx.fillText("Score:" + score, 20, 30);
		
		ctx.font = "20px Arial";
		ctx.fillText("Lives:" + lives, 20, 50);
			
		requestAnimationFrame(loop);
		//moving the paddle
		if(rightDown==true) 
			paddle.x += paddle.dx;
		if(leftDown) 
			paddle.x -= paddle.dx;
		
		//collision detection for the boundary
		//right colllison or left collision
		if (ball.x + ball.dx > WIDTH  || ball.x < 0)
			ball.dx *= -1;
		if ( ball.y < 0)
			ball.dy *= -1;
		else if (ball.y + ball.dy > paddle.y - ball.radius) {
			if (ball.x > paddle.x && ball.x < (paddle.x + paddle.width)){
				console.log("ball hits paddle");
				ball.dx *= (Math.floor(Math.random() < 0.5 ? -1: 1));
				console.log(ball.dx);
				ball.dy *= -1;
			}
			else{
				console.log("Game over");
				lives -= 1;
				startGame();
				
			}
			
		}
		
  		//update the ball position by adding dx and dy to x and y of ball
		ball.x += ball.dx;
		ball.y += ball.dy;
		
		//draw paddles and draw ball
		paddle.draw(ctx);
		ball.draw(ctx);
	}
	
	//set rightDown or leftDown if the right or left keys are down
	function onKeyDown(evt) {
	  if (evt.keyCode == 39) rightDown = true;
	  else if (evt.keyCode == 37) leftDown = true;
	  console.log("KeyDown. The code is : " + evt.keyCode);
	  //console.log(evt);
	  console.log(rightDown, leftDown);
	  
	}
	
	//and unset them when the right or left key is released
	function onKeyUp(evt) {
	  if (evt.keyCode == 39) rightDown = false;
	  else if (evt.keyCode == 37) leftDown = false;
	  console.log(rightDown, leftDown);	
	}
		
</script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Start Here</title>
</head>

<body onload="init()" onkeydown="onKeyDown(event)" onkeyup="onKeyUp(event)">
	<canvas id="canvas" width="600" height="400" style="border:1px solid #d3d3d3 bgcolor ;">
			Canvas is not supported
	</canvas>
</body>
</html>